name: CI Debug on Push — auto-create issue

on:
  push:
    branches:
      - 'ci/debug-auto'

permissions:
  contents: read
  issues: write

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Quick create issue (sanity check)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          CONTENT="Automated debug run triggered for $GITHUB_REF on $GITHUB_SHA"
          BODY=$(python3 - <<PY
import json,sys
print(json.dumps('''"""''' + CONTENT + '''"""'''))
PY
)
          PAYLOAD=$(printf '{"title":"CI Debug quick — %s","body":%s}' "$GITHUB_REF" "$BODY")
          curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" https://api.github.com/repos/$GITHUB_REPOSITORY/issues -d "$PAYLOAD" || true

      - name: Run environment diagnostics and save to file
        id: diag
        run: |
          set -euo pipefail
          out=debug-output.txt
          echo "==== date ====" > "$out"
          date >> "$out"
          echo "\n==== java -version ====" >> "$out"
          java -version 2>&1 | sed 's/^/    /' >> "$out" || true
          echo "\n==== ANDROID_HOME ====" >> "$out"
          echo "ANDROID_HOME=$ANDROID_HOME" >> "$out"
          echo "\n==== sdkmanager --version ====" >> "$out"
          ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --version 2>&1 | sed 's/^/    /' >> "$out" || true
          echo "\n==== sdkmanager --list_installed (short) ====" >> "$out"
          yes | ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --list_installed 2>&1 | sed 's/^/    /' >> "$out" || true
          echo "\n==== ls ANDROID_HOME contents ====" >> "$out"
          ls -la "$ANDROID_HOME" >> "$out" || true
          echo "\n==== ls ANDROID_HOME/ndk ====" >> "$out"
          ls -la "${ANDROID_HOME}/ndk" >> "$out" || true
          echo "\n==== gradle version (if available) ====" >> "$out"
          ./gradlew -v 2>&1 | sed 's/^/    /' >> "$out" || true
          echo "\n==== end ====" >> "$out"

      - name: Upload diagnostics (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: debug-environment
          path: debug-output.txt
          retention-days: 7

      - name: Create GitHub Issue with diagnostics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          CONTENT=$(python3 - <<PY
import json
print(json.dumps(open('debug-output.txt').read()))
PY
)
          PAYLOAD=$(printf '{"title":"CI Debug — %s","body":%s}' "$GITHUB_REF" "$CONTENT")
          echo "Creating issue with payload size: ${#PAYLOAD}"
          curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" https://api.github.com/repos/$GITHUB_REPOSITORY/issues -d "$PAYLOAD" | jq -r '.html_url // .message' || true

      - name: Create GitHub Issue (fallback, always)
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ ! -f debug-output.txt ]; then
            echo "No debug-output.txt produced; capturing job summary and environment" > debug-output.txt || true
            echo "Run URL: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${{ github.run_id }}" >> debug-output.txt || true
          fi
          CONTENT=$(python3 - <<PY
import json
print(json.dumps(open('debug-output.txt').read()))
PY
)
          PAYLOAD=$(printf '{"title":"CI Debug (fallback) — %s","body":%s}' "$GITHUB_REF" "$CONTENT")
          curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" https://api.github.com/repos/$GITHUB_REPOSITORY/issues -d "$PAYLOAD" || true

      - name: Commit diagnostics file back to branch (fallback)
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          BRANCH=${GITHUB_REF#refs/heads/}
          if [ -f debug-output.txt ]; then
            git config user.email "actions@github.com" || true
            git config user.name "GitHub Actions" || true
            git add debug-output.txt || true
            git commit -m "ci: add debug-output for ${BRANCH}" || true
            git push "https://${GITHUB_ACTOR}:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" HEAD:refs/heads/${BRANCH} || true
            echo "Pushed debug-output.txt to branch ${BRANCH}"
          else
            echo "No debug-output.txt present to commit"
          fi
