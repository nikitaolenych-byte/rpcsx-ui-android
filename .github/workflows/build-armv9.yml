name: Build RPCSX ARMv9

on:
  schedule:
    - cron: '0 0 * * 1'
  push:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      
      - name: Verify Java version
        run: |
          echo "Java version check:"
          java -version 2>&1
          JAVA_VER=$(java -version 2>&1 | head -1 | grep -oP 'version "\K[0-9]+' | head -1)
          if [ "$JAVA_VER" != "17" ]; then
            echo "❌ ERROR: Java version $JAVA_VER found, but Java 17 is required!"
            echo "JAVA_HOME: $JAVA_HOME"
            exit 1
          fi
          echo "✅ Java 17 verified"
      
      - uses: android-actions/setup-android@v3
        with:
          packages: |
            platforms;android-36
            ndk;29.0.13113456
            cmake;3.28.0
            build-tools;36.0.0
      
      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y pkg-config libadrenotools-dev 2>&1 | tail -3 || echo "libadrenotools-dev not in repo"
          echo "Build tools ready"
      
      - name: Setup NDK environment
        run: |
          export NDK_ROOT=$ANDROID_HOME/ndk/29.0.13113456
          export CMAKE_TOOLCHAIN_FILE=$NDK_ROOT/build/cmake/android.toolchain.cmake
          echo "NDK_ROOT=$NDK_ROOT" >> $GITHUB_ENV
          echo "CMAKE_TOOLCHAIN_FILE=$CMAKE_TOOLCHAIN_FILE" >> $GITHUB_ENV
          echo "Toolchain: $CMAKE_TOOLCHAIN_FILE"
          [ -f "$CMAKE_TOOLCHAIN_FILE" ] && echo "✅ Toolchain found" || echo "❌ Toolchain not found!"
      
      - name: Accept licenses
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
      
      - name: Verify build tools
        run: |
          echo "=== Environment Check ==="
          java -version 2>&1 | head -1
          cmake --version | head -1
          clang --version 2>/dev/null | head -1 || echo "clang: OK (in NDK)"
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo ""
          echo "=== NDK Check ==="
          if [ -d "$ANDROID_HOME/ndk" ]; then
            echo "NDK directory exists, contents:"
            ls -la "$ANDROID_HOME/ndk/" | head -10
          else
            echo "❌ NDK directory not found!"
          fi
          
          NDK_PATH="$ANDROID_HOME/ndk/29.0.13113456"
          if [ -d "$NDK_PATH" ]; then
            echo "✅ NDK 29.0.13113456 found at $NDK_PATH"
            echo "NDK bin tools:"
            ls -la "$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/" 2>/dev/null | grep -E "clang|aarch64" | head -5
            
            TOOLCHAIN="$NDK_PATH/build/cmake/android.toolchain.cmake"
            if [ -f "$TOOLCHAIN" ]; then
              echo "✅ CMake toolchain found: $TOOLCHAIN"
            else
              echo "❌ CMake toolchain not found!"
            fi
          else
            echo "❌ NDK 29.0.13113456 not found!"
            echo "Available NDK versions:"
            ls -la "$ANDROID_HOME/ndk/" 2>/dev/null || echo "No NDKs found"
          fi
          echo ""
          echo "=== Gradle wrapper ==="
          ./gradlew --version 2>&1 | head -3
      
      - name: Build Release APK
        run: |
          chmod +x gradlew
          echo "Starting Gradle build..."
          ./gradlew assembleRelease \
            -Pandroid.native.buildOutput=verbose \
            --no-daemon 2>&1 | tee gradle-build.log
          
          BUILD_EXIT=${PIPESTATUS[0]}
          echo "Build exit code: $BUILD_EXIT"
          
          if [ $BUILD_EXIT -ne 0 ]; then
            echo "❌ Build FAILED - showing last 200 lines of log:"
            tail -200 gradle-build.log
            exit $BUILD_EXIT
          fi
          echo "✅ Build succeeded"
      
      - name: Find APK
        if: success()
        run: |
          echo "Searching for APK..."
          find app/build -type f -name "*.apk" 2>/dev/null | head -10 || echo "No APK files found"
          
          APK=$(find app/build/outputs/apk -type f -name "*.apk" 2>/dev/null | head -1)
          if [ -z "$APK" ]; then
            echo "❌ APK not found in standard location"
            echo "Build outputs directory structure:"
            ls -la app/build/outputs/ 2>/dev/null || echo "outputs/ directory not found"
            exit 1
          fi
          
          echo "✅ Found APK: $APK"
          cp "$APK" rpcsx-armv9.apk
          ls -lh rpcsx-armv9.apk
      
      - name: Extract libs
        if: success()
        continue-on-error: true
        run: |
          mkdir -p native-libs
          unzip -q rpcsx-armv9.apk "lib/arm64-v8a/*.so" -d native-libs || true
          [ -d "native-libs/lib/arm64-v8a" ] && \
            mv native-libs/lib/arm64-v8a/* native-libs/ && \
            rmdir native-libs/lib/arm64-v8a || true
          ls -lh native-libs/
      
      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: rpcsx-armv9-apk
          path: rpcsx-armv9.apk
          retention-days: 60
      
      - name: Upload libs
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: native-libs
          path: native-libs/
          retention-days: 60
          if-no-files-found: ignore
      
      - name: Build status
        if: always()
        run: echo "Build ${{ job.status }}"
