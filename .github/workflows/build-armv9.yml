name: Build RPCSX ARMv9

on:
  schedule:
    - cron: '0 0 * * 1'
  push:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all components'
        required: false
        default: 'false'
        type: boolean

env:
  LLVM_VERSION: "19"
  NDK_VERSION: "29.0.13113456"
  CMAKE_VERSION: "3.28.0"
  
jobs:
  # ============================================================================
  # Check for component updates (like RPCS3)
  # ============================================================================
  check-updates:
    runs-on: ubuntu-24.04
    outputs:
      needs_update: ${{ steps.check.outputs.needs_update }}
      llvm_latest: ${{ steps.check.outputs.llvm_latest }}
    steps:
      - name: Check for LLVM updates
        id: check
        run: |
          echo "Checking for component updates..."
          
          # Check latest LLVM version from GitHub
          LLVM_LATEST=$(curl -s https://api.github.com/repos/llvm/llvm-project/releases/latest | jq -r '.tag_name' | grep -oP '\d+' | head -1)
          echo "Latest LLVM: $LLVM_LATEST (Current: ${{ env.LLVM_VERSION }})"
          echo "llvm_latest=$LLVM_LATEST" >> $GITHUB_OUTPUT
          
          # Check if update needed
          if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Force update requested"
          elif [ "$LLVM_LATEST" -gt "${{ env.LLVM_VERSION }}" ] 2>/dev/null; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "New LLVM version available"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "All components up to date"
          fi

  build:
    runs-on: ubuntu-24.04
    needs: check-updates
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      
      - name: Verify Java version
        run: |
          echo "Java version check:"
          java -version 2>&1
          JAVA_VER=$(java -version 2>&1 | head -1 | grep -oP 'version "\K[0-9]+' | head -1)
          if [ "$JAVA_VER" != "17" ]; then
            echo "❌ ERROR: Java version $JAVA_VER found, but Java 17 is required!"
            echo "JAVA_HOME: $JAVA_HOME"
            exit 1
          fi
          echo "✅ Java 17 verified"
      
      - name: Setup Android SDK and NDK
        run: |
          echo "Setting up Android SDK and NDK..."
          
          # Create Android SDK directory
          export ANDROID_HOME=~/android-sdk
          mkdir -p $ANDROID_HOME/cmdline-tools
          cd $ANDROID_HOME/cmdline-tools
          
          # Download cmdline-tools
          echo "Downloading cmdline-tools..."
          curl -L -o cmdline.zip "https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip"
          unzip -q cmdline.zip
          mv cmdline-tools latest
          
          # Add to PATH
          export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$PATH"
          
          # Accept licenses
          echo "Accepting licenses..."
          yes | sdkmanager --licenses 2>&1 | tail -2
          
          # Install platforms and build-tools
          echo "Installing Android SDK components..."
          sdkmanager "platforms;android-36" "build-tools;36.0.0" 2>&1 | tail -5
          
          # Install NDK
          echo "Installing NDK 29.0.13113456..."
          sdkmanager "ndk;29.0.13113456" 2>&1 | tail -5
          
          # Install CMake
          echo "Installing CMake..."
          sdkmanager "cmake;3.28.0" 2>&1 | tail -5
          
          # Set environment variables
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "$ANDROID_HOME/cmdline-tools/latest/bin:$PATH" >> $GITHUB_PATH
          
          echo "✅ Android SDK setup complete"
          ls -la $ANDROID_HOME/
      
      - name: Verify NDK installation
        run: |
          echo "=== NDK Verification ==="
          NDK_PATH="$ANDROID_HOME/ndk/29.0.13113456"
          
          if [ -d "$NDK_PATH" ]; then
            echo "✅ NDK found at: $NDK_PATH"
            echo "NDK version: $(cat $NDK_PATH/source.properties 2>/dev/null | head -1)"
            TOOLCHAIN="$NDK_PATH/build/cmake/android.toolchain.cmake"
            if [ -f "$TOOLCHAIN" ]; then
              echo "✅ CMake toolchain found"
            fi
          else
            echo "❌ NDK not found at: $NDK_PATH"
            ls -la "$ANDROID_HOME/" 2>/dev/null || echo "ANDROID_HOME doesn't exist"
            exit 1
          fi
      
      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y pkg-config libadrenotools-dev 2>&1 | tail -3 || echo "libadrenotools-dev not in repo"
          echo "✅ Build dependencies ready"
      
      - name: Setup NDK environment variables
        run: |
          export NDK_ROOT="$ANDROID_HOME/ndk/29.0.13113456"
          export CMAKE_TOOLCHAIN_FILE="$NDK_ROOT/build/cmake/android.toolchain.cmake"
          echo "NDK_ROOT=$NDK_ROOT" >> $GITHUB_ENV
          echo "CMAKE_TOOLCHAIN_FILE=$CMAKE_TOOLCHAIN_FILE" >> $GITHUB_ENV
          echo "✅ NDK environment variables set"
      
      - name: Accept licenses
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
      
      - name: Verify build tools
        run: |
          echo "=== Environment Check ==="
          java -version 2>&1 | head -1
          cmake --version | head -1
          clang --version 2>/dev/null | head -1 || echo "clang: OK (in NDK)"
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo ""
          echo "=== NDK Check ==="
          if [ -d "$ANDROID_HOME/ndk" ]; then
            echo "NDK directory exists, contents:"
            ls -la "$ANDROID_HOME/ndk/" | head -10
          else
            echo "❌ NDK directory not found!"
          fi
          
          NDK_PATH="$ANDROID_HOME/ndk/29.0.13113456"
          if [ -d "$NDK_PATH" ]; then
            echo "✅ NDK 29.0.13113456 found at $NDK_PATH"
            echo "NDK bin tools:"
            ls -la "$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/" 2>/dev/null | grep -E "clang|aarch64" | head -5
            
            TOOLCHAIN="$NDK_PATH/build/cmake/android.toolchain.cmake"
            if [ -f "$TOOLCHAIN" ]; then
              echo "✅ CMake toolchain found: $TOOLCHAIN"
            else
              echo "❌ CMake toolchain not found!"
            fi
          else
            echo "❌ NDK 29.0.13113456 not found!"
            echo "Available NDK versions:"
            ls -la "$ANDROID_HOME/ndk/" 2>/dev/null || echo "No NDKs found"
          fi
          echo ""
          echo "=== Gradle wrapper ==="
          ./gradlew --version 2>&1 | head -3
      
      - name: Build Release APK
        run: |
          chmod +x gradlew
          echo "Starting Gradle build..."
          echo "=== Pre-build check ==="
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "JAVA_HOME: $JAVA_HOME"
          ls -la $ANDROID_HOME/cmake/ 2>/dev/null | head -5 || echo "CMake listing failed"
          
          ./gradlew assembleRelease \
            -Pandroid.native.buildOutput=verbose \
            --no-daemon \
            --info 2>&1 | tee gradle-build.log
          
          BUILD_EXIT=${PIPESTATUS[0]}
          echo "Build exit code: $BUILD_EXIT"
          
          if [ $BUILD_EXIT -ne 0 ]; then
            echo "❌ Build FAILED - showing last 200 lines of log:"
            tail -200 gradle-build.log
            exit $BUILD_EXIT
          fi
          
          echo "=== Post-build outputs ==="
          find app/build -type f -name "*.apk" 2>/dev/null | head -10
          echo "✅ Build succeeded"
      
      - name: Find APK
        if: success()
        run: |
          echo "=== Searching for APK ==="
          echo "Build outputs structure:"
          ls -laR app/build/outputs/ 2>/dev/null | head -50 || echo "No outputs directory"
          
          # Try standard release location first
          APK=$(find app/build/outputs/apk -type f -name "*.apk" 2>/dev/null | head -1)
          
          # Fallback: search entire build directory
          if [ -z "$APK" ]; then
            echo "Trying fallback search..."
            APK=$(find app/build -type f -name "*.apk" 2>/dev/null | head -1)
          fi
          
          if [ -z "$APK" ]; then
            echo "❌ APK not found!"
            echo "Gradle log tail:"
            tail -100 gradle-build.log 2>/dev/null || true
            exit 1
          fi
          
          echo "✅ Found APK: $APK"
          cp "$APK" rpcsx-armv9.apk
          ls -lh rpcsx-armv9.apk
          
          # Verify APK is valid
          file rpcsx-armv9.apk
          unzip -l rpcsx-armv9.apk | head -20
      
      - name: Extract libs
        if: success()
        continue-on-error: true
        run: |
          mkdir -p native-libs
          unzip -q rpcsx-armv9.apk "lib/arm64-v8a/*.so" -d native-libs || true
          [ -d "native-libs/lib/arm64-v8a" ] && \
            mv native-libs/lib/arm64-v8a/* native-libs/ && \
            rmdir native-libs/lib/arm64-v8a || true
          ls -lh native-libs/
      
      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: rpcsx-armv9-apk
          path: rpcsx-armv9.apk
          retention-days: 60
      
      - name: Upload libs
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: native-libs
          path: native-libs/
          retention-days: 60
          if-no-files-found: ignore
      
      - name: Build status
        if: always()
        run: |
          echo "Build ${{ job.status }}"
          echo ""
          echo "=== Component Versions ==="
          echo "LLVM: ${{ env.LLVM_VERSION }}"
          echo "NDK: ${{ env.NDK_VERSION }}"
          echo "CMake: ${{ env.CMAKE_VERSION }}"
          echo "Update needed: ${{ needs.check-updates.outputs.needs_update }}"
          
  # ============================================================================
  # Auto-update job (runs when new versions detected)
  # ============================================================================
  notify-update:
    runs-on: ubuntu-24.04
    needs: [check-updates, build]
    if: needs.check-updates.outputs.needs_update == 'true' && success()
    steps:
      - name: Notify about available updates
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║  Component Updates Available                               ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo ""
          echo "Latest LLVM: ${{ needs.check-updates.outputs.llvm_latest }}"
          echo "Current LLVM: ${{ env.LLVM_VERSION }}"
          echo ""
          echo "To update, modify env.LLVM_VERSION in workflow file"
          echo "or trigger workflow with force_update=true"
