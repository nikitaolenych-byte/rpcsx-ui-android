name: Build RPCSX ARMv9

on:
  schedule:
    - cron: '0 0 * * 1'
  push:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      
      - uses: android-actions/setup-android@v3
        with:
          api-level: 36
          ndk-version: 29.0.13113456
          cmake-version: 3.28.0
      
      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y pkg-config libadrenotools-dev 2>&1 | tail -3 || echo "libadrenotools-dev not in repo"
          echo "Build tools ready"
      
      - name: Accept licenses
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
      
      - name: Build Release APK
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease \
            -Pandroid.native.buildOutput=verbose \
            --no-daemon 2>&1 | tail -100
      
      - name: Find APK
        if: success()
        run: |
          APK=$(find app/build/outputs/apk -name "*.apk" | head -1)
          [ -z "$APK" ] && echo "APK not found!" && exit 1
          cp "$APK" rpcsx-armv9.apk
          ls -lh rpcsx-armv9.apk
      
      - name: Extract libs
        if: success()
        continue-on-error: true
        run: |
          mkdir -p native-libs
          unzip -q rpcsx-armv9.apk "lib/arm64-v8a/*.so" -d native-libs || true
          [ -d "native-libs/lib/arm64-v8a" ] && \
            mv native-libs/lib/arm64-v8a/* native-libs/ && \
            rmdir native-libs/lib/arm64-v8a || true
          ls -lh native-libs/
      
      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: rpcsx-armv9-apk
          path: rpcsx-armv9.apk
          retention-days: 60
      
      - name: Upload libs
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: native-libs
          path: native-libs/
          retention-days: 60
          if-no-files-found: ignore
      
      - name: Build status
        if: always()
        run: echo "Build ${{ job.status }}"
